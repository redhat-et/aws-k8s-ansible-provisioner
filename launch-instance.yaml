---
- name: Launch AWS GPU instance in US East 2
  hosts: localhost
  connection: local
  gather_facts: true
  vars:
    aws_region: us-east-2
    instance_type:  g6.4xlarge # 1 V100 GPU or g6.4xlarge 1 L4 GPU
    ami_id: ami-00f71ac70c2d6344d  # Ubuntu 22.04 with NVIDIA GPU driver
    key_pair: router-team-us-east2
    security_group_id: sg-0704e6bcaa5e655b1  # k8s security group
    root_volume_size: 500  # GB
    instance_name: "{{ ansible_hostname }}-{{ ansible_date_time.epoch }}"
    
    # Auto-shutdown feature configuration
    auto_shutdown_enabled: true
    auto_shutdown_idle_time_minutes: 60
    
  tasks:
    - name: Ensure boto3 and botocore are installed
      pip:
        name:
          - boto3
          - botocore
        state: present
      delegate_to: localhost

    - name: Launch EC2 instance
      amazon.aws.ec2_instance:
        region: "{{ aws_region }}"
        availability_zone: "{{ aws_region }}b"
        name: "{{ instance_name }}"
        image_id: "{{ ami_id }}"
        instance_type: "{{ instance_type }}"
        key_name: "{{ key_pair }}"
        security_groups:
          - "{{ security_group_id }}"
        instance_initiated_shutdown_behavior: stop
        volumes:
          - device_name: /dev/sda1
            ebs:
              volume_type: gp3
              volume_size: "{{ root_volume_size }}"
              delete_on_termination: true
              encrypted: true
        state: running
        wait: true
        wait_timeout: 600
        tags:
          Name: "{{ instance_name }}"
          Environment: production
          InstanceType: "{{ instance_type }}"
          AMI: "{{ ami_id }}"
          CreatedBy: ansible
          CreatedAt: "{{ ansible_date_time.iso8601 }}"
      register: ec2_instance

    - name: Display instance information
      debug:
        msg:
          - "Instance launched successfully!"
          - "Instance ID: {{ ec2_instance.instances[0].instance_id }}"
          - "Instance Type: {{ ec2_instance.instances[0].instance_type }}"
          - "Public IP: {{ ec2_instance.instances[0].public_ip_address | default('N/A') }}"
          - "Private IP: {{ ec2_instance.instances[0].private_ip_address }}"
          - "State: {{ ec2_instance.instances[0].state.name }}"
          - "Launch Time: {{ ec2_instance.instances[0].launch_time }}"

    - name: Wait for SSH to become available
      wait_for:
        host: "{{ ec2_instance.instances[0].public_ip_address }}"
        port: 22
        delay: 60
        timeout: 300
        state: started
      when: ec2_instance.instances[0].public_ip_address is defined

    - name: Add instance to inventory
      add_host:
        hostname: "{{ ec2_instance.instances[0].public_ip_address | default(ec2_instance.instances[0].private_ip_address) }}"
        groupname: gpu_instances
        ansible_user: ubuntu
        ansible_ssh_private_key_file: "~/.ssh/{{ key_pair }}.pem"
        ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
        instance_id: "{{ ec2_instance.instances[0].instance_id }}"
        auto_shutdown_enabled: "{{ auto_shutdown_enabled }}"
        auto_shutdown_idle_time_minutes: "{{ auto_shutdown_idle_time_minutes }}"
      when: ec2_instance.instances[0] is defined

    - name: Save instance details to file
      copy:
        content: |
          Instance Details:
          =================
          Instance ID: {{ ec2_instance.instances[0].instance_id }}
          Instance Name: {{ instance_name }}
          Instance Type: {{ ec2_instance.instances[0].instance_type }}
          AMI ID: {{ ec2_instance.instances[0].image_id }}
          Region: {{ aws_region }}
          Public IP: {{ ec2_instance.instances[0].public_ip_address | default('N/A') }}
          Private IP: {{ ec2_instance.instances[0].private_ip_address }}
          Key Pair: {{ key_pair }}
          Security Group: {{ security_group_id }}
          Root Volume Size: {{ root_volume_size }}GB
          Launch Time: {{ ec2_instance.instances[0].launch_time }}
          
          SSH Command:
          ssh -i ~/.ssh/{{ key_pair }}.pem ubuntu@{{ ec2_instance.instances[0].public_ip_address | default(ec2_instance.instances[0].private_ip_address) }}
        dest: "./instance-{{ ec2_instance.instances[0].instance_id }}-details.txt"
      delegate_to: localhost

    - name: Generate inventory file for GPU instance
      copy:
        content: |
          [gpu_instances]
          {{ instance_name.lower().replace(' ', '-') }} ansible_host={{ ec2_instance.instances[0].public_ip_address | default(ec2_instance.instances[0].private_ip_address) }} ansible_user=ubuntu

          [all:vars]
          ansible_ssh_private_key_file=~/.ssh/{{ key_pair }}.pem
          ansible_ssh_common_args='-o StrictHostKeyChecking=no'
          ansible_become=yes
          ansible_become_method=sudo
        dest: "./gpu-inventory-{{ ec2_instance.instances[0].instance_id }}.ini"
      delegate_to: localhost


- name: Post-launch configuration
  hosts: gpu_instances
  become: yes
  gather_facts: yes
  tasks:
    - name: Update system packages
      apt:
        update_cache: yes
        upgrade: dist
        autoremove: yes
      when: ansible_os_family == "Debian"

    - name: Install packages for debugging
      apt:
        name:
          - htop
          - vim
          - curl
          - wget
          - git
          - python3-pip
        state: present
      when: ansible_os_family == "Debian"

    - name: Check NVIDIA driver installation
      command: nvidia-smi
      register: nvidia_smi_output
      ignore_errors: yes

    - name: Display NVIDIA driver status
      debug:
        msg: |
          NVIDIA Driver Status:
          {{ nvidia_smi_output.stdout if nvidia_smi_output.rc == 0 else 'NVIDIA driver not found or not working properly' }}

    - name: Check GPU availability
      shell: lspci | grep -i nvidia
      register: gpu_check
      ignore_errors: yes

    - name: Display GPU information
      debug:
        msg: "GPU Information: {{ gpu_check.stdout if gpu_check.rc == 0 else 'No NVIDIA GPU detected' }}"


- name: Configure Auto-Shutdown
  hosts: gpu_instances
  become: yes
  gather_facts: no
  
  tasks:
    - name: Copy auto-shutdown script to instance
      copy:
        src: files/auto-shutdown.sh
        dest: /usr/local/bin/auto-shutdown.sh
        mode: '0755'
        owner: root
        group: root

    - name: Create systemd service file for auto-shutdown
      copy:
        dest: /etc/systemd/system/auto-shutdown.service
        content: |
          [Unit]
          Description=Auto Shutdown Service for Idle Instances
          After=network-online.target
          Wants=network-online.target

          [Service]
          Type=simple
          # Pass configuration to the script via environment variables
          Environment="ENABLED={{ auto_shutdown_enabled | lower }}"
          Environment="IDLE_TIME_MINUTES={{ auto_shutdown_idle_time_minutes }}"
          ExecStart=/usr/local/bin/auto-shutdown.sh
          Restart=on-failure
          RestartSec=5s

          [Install]
          WantedBy=multi-user.target
        mode: '0644'

    - name: Create log file with proper permissions
      file:
        path: /var/log/auto-shutdown.log
        state: touch
        mode: '0664'
        owner: root
        group: adm

    - name: Reload systemd to recognize new service
      systemd:
        daemon_reload: yes

    - name: Enable and start auto-shutdown service
      systemd:
        name: auto-shutdown
        enabled: yes
        state: started
      when: auto_shutdown_enabled | bool 